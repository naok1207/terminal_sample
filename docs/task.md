# Claude Code開発タスクリスト - 既存ターミナルベースの段階的実装計画

## 既存コードベースの概要
- **リポジトリ**: https://github.com/naok1207/terminal_sample
- **実装済み機能**: Electron + xterm.js + node-pty の基本的なターミナル
- **構造**:
  - `src/main/terminal-manager.ts` - ターミナルセッション管理
  - `src/main/preload.ts` - IPC通信
  - `src/renderer/renderer.ts` - xterm.js UI

## フェーズ1: 親子ワーカー通信の実装

### タスク1.1: タブ機能の追加
**目的**: 既存の単一ターミナルを複数タブ対応に拡張する

**必要情報**:
- 既存のterminal-manager.tsを拡張してマルチセッション対応
- タブUIコンポーネントの実装（タブバー、タブ切り替え）
- 各タブのセッション状態管理
- アクティブタブの追跡

**実装箇所**:
- `src/renderer/renderer.ts` - タブUI追加
- `src/main/terminal-manager.ts` - 複数セッション管理
- `src/main/preload.ts` - タブ関連IPC追加

**検証項目**:
- 複数タブの作成と切り替え
- 各タブで独立したシェルセッション

---

### タスク1.2: タブの親子関係定義
**目的**: タブに親子の概念を導入し、メタデータを管理する

**必要情報**:
- タブのメタデータ構造（id, type: 'parent'|'child', parentId?, name）
- 親タブから子タブを作成するインターフェース
- 親子関係の視覚的表現（タブの色分け、アイコンなど）

**実装箇所**:
- 新規: `src/types/tab.ts` - タブ型定義
- 修正: `src/main/terminal-manager.ts` - 親子関係管理

**検証項目**:
- 親タブから子タブの作成
- 親子関係の正しい保持

---

### タスク1.3: 親から子へのコマンド送信機構
**目的**: 親タブから子タブのPTYプロセスにコマンドを送信する

**必要情報**:
- 親タブ用の特別なコマンドインターフェース（例: `@child1: command`）
- コマンドのパースとルーティング
- 子タブPTYへの書き込み処理
- 送信履歴の管理

**実装箇所**:
- 新規: `src/main/command-router.ts` - コマンドルーティング
- 修正: `src/renderer/renderer.ts` - 親タブのコマンド処理

**検証項目**:
- 親タブから`@child1: ls -la`のようなコマンドが子タブで実行される
- 通常のコマンドは親タブ自身で実行される

---

### タスク1.4: 子から親への結果返送
**目的**: 子タブの実行結果を構造化して親タブに返送する

**必要情報**:
- 子タブ出力のキャプチャとバッファリング
- 結果メッセージの構造（timestamp, childId, command, output, exitCode）
- 親タブへの通知チャンネル
- 親タブでの結果表示フォーマット

**実装箇所**:
- 新規: `src/main/output-capture.ts` - 出力キャプチャ
- 修正: `src/main/preload.ts` - 結果通知IPC

**検証項目**:
- 子タブの実行完了が親タブに通知される
- 親タブで構造化された結果が確認できる

---

### タスク1.5: Claude Code統合
**目的**: 子タブでClaude Codeコマンドを実行し、JSON出力を処理する

**必要情報**:
- claude codeコマンドの検出（コマンドが`claude`で始まるかチェック）
- `--output-format json`の自動付与オプション
- JSON出力のパースとエラーハンドリング
- Claude Code特有の出力フォーマット処理

**実装箇所**:
- 新規: `src/main/claude-integration.ts` - Claude Code処理
- 修正: `src/main/command-router.ts` - Claude検出追加

**検証項目**:
- `claude -p "Hello"` が自動的にJSON形式で実行される
- パースされた結果が親タブに構造化して表示される

---

## フェーズ2: 複数子ワーカーの管理

### タスク2.1: 複数子タブの動的作成
**目的**: 親タブから複数の子タブを動的に作成・管理する

**必要情報**:
- 子タブ作成コマンド（例: `@create-child: worker1`）
- 子タブの自動命名規則
- タブ数上限の管理（推奨: 5）
- 子タブ一覧表示機能

**実装箇所**:
- 修正: `src/main/terminal-manager.ts` - 動的タブ作成
- 新規: `src/renderer/tab-manager-ui.ts` - タブ管理UI

**検証項目**:
- 親タブから3つの子タブを動的作成
- 各子タブが独立して動作

---

### タスク2.2: 作業ディレクトリの分離
**目的**: 各子ワーカーが独立した作業環境を持つようにする

**必要情報**:
- 子タブ作成時の作業ディレクトリ指定
- Claude Code内での`cd`コマンドによる移動
- 環境変数の分離設定
- 作業ディレクトリの表示

**実装箇所**:
- 修正: `src/main/terminal-manager.ts` - cwd管理
- 修正: タブUIに現在のディレクトリ表示

**検証項目**:
- 各子タブが異なるディレクトリで動作
- ディレクトリ変更が他のタブに影響しない

**注**: git worktreeやDockerはClaude Code側で`cd`や環境設定として処理

---

### タスク2.3: ワーカープール実装
**目的**: 子ワーカーをプールとして管理し、タスクを効率的に配布する

**必要情報**:
- ワーカー状態（idle/busy/error）の追跡
- タスクキューの実装
- ラウンドロビンまたは負荷ベースの割り当て
- ワーカーの自動リサイクル（30分または100タスク後）

**実装箇所**:
- 新規: `src/main/worker-pool.ts` - ワーカープール管理
- 修正: `src/main/command-router.ts` - プール統合

**検証項目**:
- 複数タスクが適切に分配される
- ビジーなワーカーがスキップされる

---

## フェーズ3: タスク分割と並列実行

### タスク3.1: バッチコマンド実行
**目的**: 複数のコマンドを一括で子ワーカーに配布する

**必要情報**:
- バッチコマンド構文（例: `@batch: ["cmd1", "cmd2", "cmd3"]`）
- タスクの依存関係定義（sequentialまたはparallel）
- 実行順序の制御
- 進捗追跡

**実装箇所**:
- 新規: `src/main/batch-executor.ts` - バッチ実行
- 修正: `src/main/command-router.ts` - バッチ検出

**検証項目**:
- 3つのコマンドが適切に分配実行される
- 実行順序が保たれる（sequential時）

---

### タスク3.2: 並列実行モニタリング
**目的**: 複数の子ワーカーの実行状況をリアルタイムで監視する

**必要情報**:
- 実行状況ダッシュボード（各ワーカーの状態表示）
- 実行中のコマンド表示
- 完了/エラー数の集計
- 全体進捗の計算

**実装箇所**:
- 新規: `src/renderer/execution-monitor.ts` - モニタUI
- 修正: `src/main/worker-pool.ts` - 状態通知

**検証項目**:
- 全ワーカーの状態が一覧表示される
- リアルタイムで状態が更新される

---

## フェーズ4: コンテキスト共有（シンプル版）

### タスク4.1: 環境変数の共有
**目的**: 親タブで設定した環境変数を子タブに伝播する

**必要情報**:
- 共有環境変数の設定コマンド（例: `@env: KEY=VALUE`）
- 子タブ作成時の環境変数継承
- 環境変数の一覧表示
- 上書き/追加の制御

**実装箇所**:
- 新規: `src/main/env-manager.ts` - 環境変数管理
- 修正: `src/main/terminal-manager.ts` - 環境変数継承

**検証項目**:
- 親で設定した変数が子で参照できる
- 子での変更が他に影響しない

---

### タスク4.2: 実行結果の変数化
**目的**: 子タブの実行結果を変数として保存し、他のコマンドで参照する

**必要情報**:
- 結果の変数保存構文（例: `@child1: command > $result1`）
- 変数の参照構文（例: `@child2: echo $result1`）
- 変数のスコープ管理
- 変数一覧表示

**実装箇所**:
- 新規: `src/main/variable-store.ts` - 変数管理
- 修正: `src/main/command-router.ts` - 変数処理

**検証項目**:
- 実行結果が変数に保存される
- 他のコマンドで変数が参照できる

---

## フェーズ5: エラーハンドリング

### タスク5.1: エラー検知と通知
**目的**: 各種エラーを検知し、親タブに通知する

**必要情報**:
- PTYプロセスの異常終了検知
- Claude Codeのエラー出力パース
- ネットワークタイムアウト検知
- エラーの分類と重要度

**実装箇所**:
- 新規: `src/main/error-handler.ts` - エラー処理
- 修正: 各モジュールにエラー通知追加

**検証項目**:
- プロセスクラッシュが検知される
- エラーが親タブに通知される

---

### タスク5.2: 自動リトライ機構
**目的**: 一時的なエラーに対して自動リトライを行う

**必要情報**:
- リトライ可能エラーの判定（ネットワーク、レート制限など）
- 指数バックオフの実装（初期1秒、最大60秒）
- リトライ回数制限（デフォルト3回）
- リトライ状況の表示

**実装箇所**:
- 新規: `src/main/retry-manager.ts` - リトライ管理
- 修正: `src/main/claude-integration.ts` - リトライ統合

**検証項目**:
- ネットワークエラー時に自動リトライ
- 最大回数で諦める

---

## フェーズ6: リアルタイム進捗表示

### タスク6.1: ストリーミング出力対応
**目的**: Claude Codeのストリーミング出力をリアルタイム表示する

**必要情報**:
- `--output-format stream-json`オプションの使用
- Server-Sent Events形式のパース
- プログレスバーの計算ロジック
- バッファリングとUI更新の最適化

**実装箇所**:
- 新規: `src/main/stream-parser.ts` - ストリーム処理
- 新規: `src/renderer/progress-ui.ts` - 進捗UI

**検証項目**:
- トークンごとの出力が表示される
- 進捗バーが滑らかに更新される

---

## フェーズ7: 実行履歴

### タスク7.1: 履歴の記録と表示
**目的**: 全ての実行を記録し、後から参照できるようにする

**必要情報**:
- SQLiteデータベースの設定（electron-storeも検討）
- 履歴スキーマ（timestamp, command, output, duration, status）
- 履歴ビューアUI
- 検索・フィルタ機能

**実装箇所**:
- 新規: `src/main/history-db.ts` - 履歴DB
- 新規: `src/renderer/history-viewer.ts` - 履歴UI

**検証項目**:
- 実行が自動的に記録される
- 履歴から過去の実行を確認できる

---

## 実装における重要な考慮事項

1. **既存コードの活用**: terminal-manager.tsを拡張して実装
2. **段階的な機能追加**: 各フェーズを完了してから次へ
3. **Claude Codeとの統合**: JSON出力を基本として扱う
4. **エラー処理**: 各機能に基本的なエラー処理を含める
5. **パフォーマンス**: タブ数制限とリソース管理を意識

このタスクリストは既存のターミナル実装を最大限活用しながら、段階的に親子ワーカー機能を追加していく設計になっています。
